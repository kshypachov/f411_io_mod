# F411 IO Mod Project

![Build Status](https://github.com/kshypachov/f411_io_mod/actions/workflows/c-cpp.yml/badge.svg)

This project is designed to run on the STM32F411CEUX microcontroller, handling input/output control, networking, and MQTT-based communication. The application interfaces with sensors and actuators, updates statuses in Home Assistant, and uses FreeRTOS to manage concurrent tasks.

## Features

- **MQTT Communication**: Publishes sensor data and subscribes to commands using MQTT, supporting integration with Home Assistant.
- **FreeRTOS Tasks**: Implements separate tasks for Ethernet management, IO control, display updates, and settings management.
- **Network Management**: Uses the Mongoose networking library to manage TCP/IP and WebSocket connections.
- **Persistent Storage**: Utilizes LittleFS with SPI Flash for settings and file storage.

## Getting Started

### Prerequisites

- STM32CubeIDE with STM32 HAL and CMSIS libraries
- FreeRTOS for task management
- Home Assistant (for MQTT integration)
- Mongoose Library (for network handling)

### Building and Flashing

1. Clone this repository:
    ```bash
    git clone https://github.com/kshypachov/f411_io_mod
    ```

2. Open the project in **STM32CubeIDE** and build.

3. Flash the binary to your STM32F411CEUX microcontroller using a compatible programmer (e.g., ST-Link).

### Configuration

#### MQTT

- Update your MQTT broker URL, username, and password in the `mqtt.cpp` initialization function.

- Ensure that Home Assistant is configured to accept MQTT messages and includes topics generated by the project’s MQTT configuration.

#### GPIO and IO

- Configure the input/output pins as needed for your application in `freertos.c` or in the STM32CubeMX `.ioc` file.

3. Flash the binary to your STM32F411CEUX microcontroller using a compatible programmer (e.g., ST-Link).

### Configuration

#### MQTT

- Update your MQTT broker URL, username, and password in the `mqtt.cpp` initialization function.

- Ensure that Home Assistant is configured to accept MQTT messages and includes topics generated by the project’s MQTT configuration.

#### GPIO and IO

- Configure the input/output pins as needed for your application in `freertos.c` or in the STM32CubeMX `.ioc` file.

## Web API Documentation

The device exposes a RESTful API for remote configuration and control.

### Device and IO Management

- **`GET /api/ram/status`**
  - **Description**: Returns information about free and allocated RAM space.
  - **Response**:
    ```json
    {
        "xAvailableHeapSpaceInBytes": "11688",
        "xSizeOfLargestFreeBlockInBytes": "9528",
        "xSizeOfSmallestFreeBlockInBytes": "48",
        "xNumberOfFreeBlocks": "4",
        "xMinimumEverFreeBytesRemaining": "1976",
        "xNumberOfSuccessfulAllocations": "215",
        "xNumberOfSuccessfulFrees": "180"
    }
    ```

- **`GET /api/io/status`**
  - **Description**: Retrieves the current state of all inputs and outputs.
  - **Response**:
    ```json
    {
      "inputs": [0, 1, 0],
      "outputs": [1, 0, 1]
    }
    ```

- **`POST /api/io/status`**
  - **Description**: Controls output states.
  - **Request Body**:
    ```json
    {
      "relay_id": 1,
      "state": 1
    }
    ```
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Output updated"
    }
    ```

### MQTT Configuration

- **`GET /api/mqtt/settings`**
  - **Description**: Retrieves the current MQTT settings.
  - **Response**:
    ```json
    {
      "enabled": true,
      "broker": "mqtt://broker.example.com",
      "username": "user",
      "password": "******"
    }
    ```

- **`POST /api/mqtt/settings`**
  - **Description**: Updates MQTT configuration settings.
  - **Request Body**:
    ```json
    {
      "uri": "mqtt://broker.example.com",
      "username": "user",
      "password": "pass"
    }
    ```
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "MQTT settings updated"
    }
    ```

### Device Management

- **`GET /api/device/status`**
  - **Description**: Returns the device's MQTT connection status and IP addresses.
  - **Response**:
    ```json
    {
      "mqtt_conn_status": "connected",
      "local_addr": "192.168.1.10",
      "server_addr": "broker.example.com"
    }
    ```

- **`POST /api/device/restart`**
  - **Description**: Reboots the device.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Device is restarting"
    }
    ```

### Firmware Update

- **`POST /api/firmware/upload`**
  - **Description**: Uploads a new firmware file.
  - **Request**: Send `firmware.bin` as the file with `multipart/form-data`.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Firmware uploaded"
    }
    ```

- **`GET /api/firmware/md5`**
  - **Description**: Retrieves the MD5 hash of the uploaded firmware.
  - **Response**:
    ```json
    {
      "status": "success",
      "md5": "5d41402abc4b2a76b9719d911017c592"
    }
    ```

- **`GET /api/firmware/activate`**
  - **Description**: Checks if the firmware is currently activated.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Firmware activated"
    }
    ```

- **`POST /api/firmware/activate`**
  - **Description**: Activates the uploaded firmware.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Firmware activated"
    }
    ```

- **`POST /api/firmware/deactivate`**
  - **Description**: Deactivates the current firmware.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Firmware deactivated"
    }
    ```

### Web Interface Management

- **`POST /api/web_interface/remove`**
  - **Description**: Deletes all files from the web interface directory.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "All web files deleted"
    }
    ```

- **`POST /api/web_interface/upload`**
  - **Description**: Uploads new files for the web interface.
  - **Request**: Send files with `multipart/form-data` to upload.
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Web interface files uploaded"
    }
    ```

- **`POST /api/web_interface/mkdir`**
  - **Description**: Creates a new directory within the web interface.
  - **Request Body**:
    ```json
    {
      "name": "new_folder"
    }
    ```
  - **Response**:
    ```json
    {
      "status": "success",
      "message": "Directory created"
    }
    ```

### CORS Support

- **`OPTIONS`**: Handles CORS preflight requests, allowing cross-origin access for GET, POST, and OPTIONS methods.

### Usage

1. **MQTT Integration**: Once connected to a broker, the device will publish sensor data and subscribe to control topics. Configuration data is stored in `/settings/mqtt.conf`.

2. **Tasks**:
   - **Ethernet Task**: Manages MQTT connectivity.
   - **IO Task**: Reads sensor states and controls output relays.
   - **Display Task**: (Future expansion) For displaying data on an attached screen.
   - **Settings Task**: Manages persistent storage and reads configuration from flash memory.

### License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

### Contributions

Contributions are welcome! Please submit issues or pull requests to enhance the functionality or fix bugs.

### Acknowledgments

- [STM32 HAL and CMSIS Libraries](https://www.st.com/)
- [FreeRTOS](https://www.freertos.org/)
- [Mongoose Networking Library](https://www.cesanta.com/)
- [Home Assistant](https://www.home-assistant.io/)

## Contact

For any questions, please reach out via [GitHub Issues](https://github.com/yourusername/f411_io_mod/issues).

### Usage

1. **MQTT Integration**: Once connected to a broker, the device will publish sensor data and subscribe to control topics. Configuration data is stored in `/settings/mqtt.conf`.

2. **Tasks**:
   - **Ethernet Task**: Manages MQTT connectivity.
   - **IO Task**: Reads sensor states and controls output relays.
   - **Display Task**: (Future expansion) For displaying data on an attached screen.
   - **Settings Task**: Manages persistent storage and reads configuration from flash memory.

### License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

### Contributions

Contributions are welcome! Please submit issues or pull requests to enhance the functionality or fix bugs.

### Acknowledgments

- [STM32 HAL and CMSIS Libraries](https://www.st.com/)
- [FreeRTOS](https://www.freertos.org/)
- [Mongoose Networking Library](https://www.cesanta.com/)
- [Home Assistant](https://www.home-assistant.io/)

## Contact

For any questions, please reach out via [GitHub Issues](https://github.com/kshypachov/f411_io_mod/issues)
